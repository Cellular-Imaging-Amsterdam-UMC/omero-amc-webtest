<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draggable Widget</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #draggable {
            position: fixed;
            bottom: 50px;
            right: 50px;
            width: 300px;
            height: 400px;
            background-color: lightgrey;
            border: 1px solid #ccc;
            z-index: 1000; /* Ensure it's on top of other elements */
            overflow: auto; /* Add scroll if content overflows */
        }
        .script-menu ul {
            list-style-type: none;
            padding: 0;
            margin-left: 20px; /* Indentation for nested lists */
        }
        .script-menu li {
            margin: 5px 0;
        }
        .script-menu a {
            text-decoration: none;
            color: #000;
        }
        .script-menu a:hover {
            text-decoration: underline;
        }
    </style>
    <!-- jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $(document).ready(function() {
            $("#draggable").draggable().resizable();

            // Function to fetch and render the script menu
            function fetchScriptMenu() {
                var url = "{% url 'list_scripts' %}"; // URL to fetch the script menu

                console.log("Fetching script menu with URL:", url);

                // Make an AJAX GET request to fetch the script menu
                $.ajax({
                    url: url,
                    type: "GET",
                    success: function(response) {
                        // Handle the response from the server
                        console.log("Script menu fetched successfully:", response);

                        // Check the structure of the response
                        if (Array.isArray(response)) {
                            var scriptMenuHtml = buildScriptMenuHtml(response);
                            $("#draggable").html(scriptMenuHtml);

                            // Bind click event to script links to use OME.openScriptWindow
                            $("#draggable").on('click', 'a', function(event) {
                                var $a = $(event.target),
                                    script_url = $a.attr('href');
                                if (script_url != "#") {
                                    // Clicked on script - handled by OME.openScriptWindow
                                    event.preventDefault();
                                    OME.openScriptWindow(event);
                                    return false;
                                }

                                // we have clicked on <a> within a <li>, with sibling <ul>
                                var $li = $a.parent(),
                                    $ul = $li.children('ul');
                                if ($li.hasClass('menu_back')) {
                                    $li.parent().parent().siblings().show();
                                    $li.parent().hide();
                                    $li.parent().siblings('a').show();
                                } else {
                                    $ul.show();
                                    $li.siblings().hide();
                                    $a.hide();
                                }
                            });
                        } else {
                            console.error("Unexpected response format:", response);
                            $("#draggable").html("<p>Error loading script menu.</p>");
                        }
                    },
                    error: function(xhr, status, error) {
                        // Handle any errors
                        console.error("Error fetching script menu:", error);
                        console.log("Status:", status);
                        console.log("XHR:", xhr);
                        console.log("Response Text:", xhr.responseText);
                        $("#draggable").html("<p>Error loading script menu.</p>");
                    }
                });
            }

            // Function to build the script menu HTML
            function buildScriptMenuHtml(scriptMenu) {
                var html = '<div class="script-menu"><ul>';
                scriptMenu.forEach(function(folder) {
                    html += '<li><a href="#" title="' + folder.name + '">' + folder.name + '</a><ul>';
                    folder.ul.forEach(function(item) {
                        if (item.id) {
                            html += '<li><a href="/webclient/script_ui/' + item.id + '/">' + item.name + '...</a></li>';
                        } else {
                            html += '<li class="menuItem"><a href="#">' + item.name + '</a>';
                            html += '<ul>' + buildScriptMenuHtml([item]) + '</ul>';
                            html += '</li>';
                        }
                    });
                    html += '</ul></li>';
                });
                html += '</ul></div>';
                return html;
            }

            // Fetch and render the script menu on page load
            fetchScriptMenu();
        });
    </script>
</head>
<body>
    <div id="draggable">
        <!-- Script menu will be loaded here -->
        <p>Loading script menu...</p>
    </div>
</body>
</html>